<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èŠå¤©å®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <style type="text/tailwindcss">
        @layer utilities {
            .bg-custom {
                background: #ffffff;
            }
            .messages-container {
                height: calc(100vh - 140px);
                padding-bottom: 80px;
            }
            .message-bubble {
                position: relative;
                max-width: 85%;
                word-break: break-word;
                hyphens: auto;
            }
            .relationship-progress {
                width: 200px;
                height: 6px;
                background: #e2e8f0;
                border-radius: 3px;
                overflow: hidden;
            }
            .relationship-bar {
                height: 100%;
                background: linear-gradient(90deg, #EC4899 0%, #8B5CF6 100%);
                transition: width 0.5s ease;
            }
            .relationship-level {
                font-size: 12px;
                color: #6B7280;
            }
            .character-avatar {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                overflow: hidden;
                border: 2px solid #e5e7eb;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                background: white;
            }
            .character-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.3s ease;
            }
            .character-avatar:hover img {
                transform: scale(1.1);
            }
            .character-avatar-small {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                overflow: hidden;
                border: 2px solid #e5e7eb;
                flex-shrink: 0;
            }
            .character-avatar-small img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .messages-container {
                padding: 1rem;
                scroll-behavior: smooth;
            }
            .messages-container > div:last-child {
                margin-bottom: 2rem;
            }
            .back-btn {
                transition: all 0.2s ease;
            }
            .back-btn:hover {
                transform: translateX(-2px);
            }
            .back-btn:active {
                transform: scale(0.95);
            }
            /* ç‚ºæ¥ªæçš„æ¶ˆæ¯æ·»åŠ ç‰¹æ®Šæ¨£å¼ */
            .character-message.inori {
                background: linear-gradient(135deg, #ffebee 0%, #f3e5f5 100%);
                border-left: 3px solid #ec407a;
            }
            
            .character-avatar.inori img {
                border-color: #ec407a;
            }

            /* ç‚ºå°è¢å¹•æ·»åŠ éŸ¿æ‡‰å¼æ¨£å¼ */
            @media (max-width: 640px) {
                .character-avatar {
                    width: 40px;
                    height: 40px;
                }

                .character-avatar-small {
                    width: 28px;
                    height: 28px;
                }

                #chatTitle {
                    font-size: 1rem;
                }

                .relationship-progress {
                    width: 150px;
                }

                /* èª¿æ•´é ‚éƒ¨å°èˆªæ¬„ */
                nav .max-w-7xl {
                    padding: 0.5rem 1rem;
                }

                /* èª¿æ•´è¼¸å…¥å€åŸŸ */
                #messageForm {
                    gap: 0.5rem;
                }

                #messageForm input {
                    font-size: 0.875rem;
                    padding: 0.5rem 1rem;
                }

                #messageForm button {
                    padding: 0.5rem 1rem;
                    font-size: 0.875rem;
                }

                .suggestions-container {
                    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                    padding: 8px;
                    gap: 8px;
                    bottom: 70px;
                }

                .suggestion-btn {
                    font-size: 0.875rem;
                    min-height: 40px;
                    padding: 10px 14px;
                }
            }

            /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
            .suggestions-container::-webkit-scrollbar {
                width: 4px;
            }

            .suggestions-container::-webkit-scrollbar-track {
                background: transparent;
            }

            .suggestions-container::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.1);
                border-radius: 2px;
            }

            /* ç¢ºä¿å»ºè­°æŒ‰éˆ•åœ¨è§¸æ‘¸è¨­å‚™ä¸Šæœ‰æ­£ç¢ºçš„é»æ“Šå€åŸŸ */
            @media (hover: none) {
                .suggestion-btn {
                    min-height: 48px; /* å¢åŠ è§¸æ‘¸å€åŸŸ */
                    padding: 14px 18px;
                }
            }

            /* é˜²æ­¢æ»¾å‹•ç©¿é€ */
            .suggestions-container {
                overscroll-behavior: contain;
            }

            /* ä¿®æ”¹è¼¸å…¥å€åŸŸæ¨£å¼ */
            .input-area {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                padding: 8px 16px;
                border-top: 1px solid rgba(0,0,0,0.1);
                z-index: 1001; /* ç¢ºä¿åœ¨å»ºè­°å›è¦†ä¸Šæ–¹ */
            }
            
            /* ç¢ºä¿å»ºè­°å›è¦†å®¹å™¨ä¸æœƒæ“‹ä½è¼¸å…¥æ¡† */
            .suggestions-container {
                bottom: 70px; /* èª¿æ•´ä½ç½®é¿å…é®æ“‹ */
                z-index: 1000;
                position: fixed;
                background: rgba(255,255,255,0.95);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(0,0,0,0.1);
                box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.1);
                touch-action: pan-x pan-y; /* å…è¨±æ»¾å‹• */
            }
            
            /* æ”¹é€²å»ºè­°æŒ‰éˆ•çš„è§¸æ‘¸å€åŸŸ */
            .suggestion-btn {
                min-height: 44px;
                padding: 12px 16px;
                margin: 4px 0;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                position: relative;
                z-index: 1;
            }

            /* ç§»å‹•è¨­å‚™å„ªåŒ– */
            @media (max-width: 640px) {
                .input-area {
                    padding: 8px;
                }
                
                #messageInput {
                    font-size: 16px !important; /* é˜²æ­¢ iOS ç¸®æ”¾ */
                    padding: 8px 12px !important;
                    line-height: 1.5;
                    min-height: 40px;
                }
                
                .suggestion-btn {
                    min-height: 48px;
                    padding: 12px;
                    font-size: 14px;
                }
            }

            /* æ–°å¢å‹•ä½œæè¿°æ¨£å¼ */
            .action-description {
                @apply text-purple-600 text-sm pl-3 ml-2 border-l-2 border-purple-200;
                position: relative;
                animation: fadeInLeft 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }
            .action-description::before {
                content: "âœ¦";
                @apply text-purple-400 mr-2 font-light;
                position: absolute;
                left: -0.8em;
                top: 0.1em;
            }
            /* å¼·åŒ–å ´æ™¯æè¿° */
            .scene-description {
                @apply text-gray-600 text-sm italic my-4 p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg;
                border-left: 4px solid #8B5CF6;
                box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);
                position: relative;
            }
            .scene-description::before {
                content: "ğŸœ²";
                @apply text-purple-300 absolute -left-4 top-2 text-xl;
            }
            /* ç‰¹æ®Šå‹•ä½œå®¹å™¨ */
            .special-actions {
                @apply mt-2 space-y-1;
            }
            /* å–®å€‹å‹•ä½œæ¨£å¼ */
            .action-item {
                @apply flex items-center text-sm text-purple-600 pl-3;
                animation: slideIn 0.3s ease-out;
            }
            .action-icon {
                @apply w-4 h-4 mr-2 flex-shrink-0;
            }
            /* ä¸åŒå‹•ä½œé¡å‹çš„åœ–ç¤º */
            .action-touch .action-icon {
                background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>');
            }
            .action-emotion .action-icon {
                background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>');
            }
            /* å‹•ç•«æ•ˆæœ */
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateX(10px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
        }
    </style>
</head>
<body class="min-h-screen bg-custom font-['Noto_Sans_TC']">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-white shadow fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-2">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2 sm:gap-4">
                    <!-- æ·»åŠ è¿”å›æŒ‰éˆ• -->
                    <button onclick="window.location.href='index.html'" 
                        class="back-btn p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <!-- è§’è‰²é ­åƒ -->
                    <div class="character-avatar w-12 h-12 rounded-full overflow-hidden border-2 border-purple-200">
                        <img id="characterAvatar" src="" alt="è§’è‰²é ­åƒ" class="w-full h-full object-cover">
                    </div>
                    <div>
                    <h1 id="chatTitle" class="text-xl font-semibold text-gray-900"></h1>
                        <!-- é—œä¿‚å€¼é¡¯ç¤º -->
                        <div class="flex items-center gap-2">
                            <div class="relationship-progress bg-gray-100 rounded-full">
                                <div id="relationshipBar" class="relationship-bar rounded-full" style="width: 0%"></div>
                            </div>
                            <span id="relationshipLevel" class="relationship-level"></span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="resetChat()" class="reset-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    <button onclick="signOut()" class="logout-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- èŠå¤©å€åŸŸ -->
    <div class="pt-16 pb-20 px-2 sm:px-4">
        <div class="max-w-3xl mx-auto messages-container overflow-y-auto py-2 px-2 sm:px-4" id="messagesContainer">
            <!-- ç³»çµ±æç¤ºè¨Šæ¯ -->
            <div class="flex justify-center mb-6">
                <div class="bg-gray-100 text-gray-600 px-4 py-2 rounded-full text-sm">
                    é–‹å§‹å’Œå°æ–¹èŠå¤©å§ï¼
                </div>
            </div>
        </div>
    </div>

    <!-- è¼¸å…¥å€åŸŸ -->
    <div class="input-area">
        <form id="messageForm" class="max-w-3xl mx-auto flex gap-2">
            <input type="text" id="messageInput" 
                class="flex-1 bg-gray-100 rounded-xl px-4 py-2 text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-400"
                placeholder="è¼¸å…¥è¨Šæ¯..."
                autocomplete="off"
                style="font-size: 16px">
            <button type="submit" 
                class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all duration-200">
                ç™¼é€
            </button>
        </form>
    </div>

    <script>
        // åœ¨è…³æœ¬é–‹é ­æ·»åŠ  isSubmitting è®Šæ•¸
        let isSubmitting = false;

        // é¦–å…ˆå®šç¾©æ‰€æœ‰éœ€è¦çš„å‡½æ•¸
        
        // æ·»åŠ æ¶ˆæ¯å‡½æ•¸å®šç¾©
        function addMessage(message, type, actionInfo = null) {
            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'} mb-4 items-end gap-2`;
            
            const bubbleClass = type === 'user' 
                ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' 
                : 'bg-gray-100 text-gray-700';
            
            let messageContent = message;
            if (type === 'character' && actionInfo) {
                messageContent += `<div class="mt-2 text-sm text-gray-500 italic">
                    [å‹•ä½œï¼š${actionInfo.action}]<br>
                    [è¡¨æƒ…ï¼š${actionInfo.emotion}]
                </div>`;
            }
            
            // æ–°å¢æ¶ˆæ¯è§£æé‚è¼¯
            const parsedMessage = parseMessageContent(message);
            
            // å¦‚æœæœ‰å‹•ä½œä¿¡æ¯ï¼Œæ·»åŠ ç‰¹æ®Šå‹•ä½œå€å¡Š
            let actionContent = '';
            if (actionInfo) {
                actionContent = `
                    <div class="special-actions">
                        <div class="action-item action-touch">
                            <span class="action-icon"></span>
                            ${actionInfo.action}
                        </div>
                        <div class="action-item action-emotion">
                            <span class="action-icon"></span>
                            ${actionInfo.emotion}
                        </div>
                    </div>
                `;
            }
            
            // ä¿®æ”¹æ¶ˆæ¯å…§å®¹çµæ§‹
            messageContent = `
                ${parsedMessage.parsedScene ? `<div class="scene-description">${parsedMessage.parsedScene}</div>` : ''}
                ${parsedMessage.parsedMessage ? `<div class="message-text">${parsedMessage.parsedMessage}</div>` : ''}
                ${parsedMessage.parsedActions.map(a => `
                    <div class="action-description">
                        ${a}
                    </div>
                `).join('')}
                ${actionContent}
            `;
            
            // æ·»åŠ é ­åƒå’Œæ¶ˆæ¯æ°£æ³¡çš„ HTML
            if (type === 'character') {
                const character = localStorage.getItem('selectedCharacter');
                let avatarSrc;
                
                // æ ¹æ“šè§’è‰²é¸æ“‡å°æ‡‰çš„é ­åƒ
                switch(character) {
                    case 'æ¥ªæ':
                        avatarSrc = 'æ¥ªæ.jpeg';
                        break;
                    case 'éœ¸ç¸½':
                        avatarSrc = 'éœ¸ç¸½.jpeg';
                        break;
                    case 'æœ›å®‡':
                        avatarSrc = 'æœ›å®‡.jpeg';
                        break;
                    default:
                        avatarSrc = 'default.jpeg';
                }
                
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 rounded-full overflow-hidden">
                        <img src="${avatarSrc}" alt="${character}é ­åƒ" class="w-full h-full object-cover">
                    </div>
                    <div class="message-bubble ${bubbleClass} px-4 py-2 rounded-2xl shadow-sm max-w-[70%]">
                        ${messageContent}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-bubble ${bubbleClass} px-4 py-2 rounded-2xl shadow-sm max-w-[70%]">
                        ${messageContent}
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ä¿®æ”¹æ¶ˆæ¯è§£æå‡½æ•¸
        function parseMessageContent(message) {
            // å¢å¼·å ´æ™¯æè¿°è§£æ
            const sceneRegex = /\(([^)]+)\)/g;  // ç°¡åŒ–åŒ¹é…æ¨¡å¼
            let parsedScene = '';
            const sceneMatches = [];
            let match;
            while ((match = sceneRegex.exec(message)) !== null) {
                sceneMatches.push(match[1]);
            }
            if (sceneMatches.length > 0) {
                parsedScene = sceneMatches.join(' ');
                message = message.replace(sceneRegex, ''); 
            }

            // å¼·åŒ–å‹•ä½œè§£æ
            const actionRegex = /\*([^*]+)\*/g;
            const parsedActions = [];
            message = message.replace(actionRegex, (_, p1) => {
                parsedActions.push(p1
                    .replace(/[ã€‚ï¼Œ]/g, '') // ç§»é™¤æ¨™é»
                    .replace(/(è¼•è¼•|å¾®å¾®)/g, '') // ç²¾ç°¡å‰¯è©
                    .trim()
                );
                return '';
            });

            return {
                parsedMessage: message.trim(),
                parsedActions,
                parsedScene
            };
        }

        // æ·»åŠ ç³»çµ±æ¶ˆæ¯å‡½æ•¸
        function addSystemMessage(message) {
            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-center mb-4';
            messageDiv.innerHTML = `
                <div class="system-message px-4 py-2 rounded-full bg-gray-100 text-gray-600 text-sm">
                    ${message}
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ä¿®æ”¹ç™¼é€è¨Šæ¯å¾Œçš„è™•ç†
        const handleSubmit = async function(e) {
            e.preventDefault();
            
            // æ·»åŠ é˜²é‡è¤‡æäº¤æª¢æŸ¥
            if (isSubmitting) {
                showToast('è«‹ç­‰å¾…ç•¶å‰è¨Šæ¯ç™¼é€å®Œæˆ', 'warning');
                return;
            }
            isSubmitting = true;

            // ä¿å­˜è¼¸å…¥æŒ‡ç¤ºå™¨çš„å¼•ç”¨
            let typingIndicator = null;

            try {
                const messageInput = document.getElementById('messageInput');
                if (!messageInput) {
                    console.error('æ‰¾ä¸åˆ°è¼¸å…¥æ¡†å…ƒç´ ');
                    isSubmitting = false;
                    return;
                }

                const message = messageInput.value.trim();
                const character = localStorage.getItem('selectedCharacter');
                
                if (!character) {
                    console.error('æœªé¸æ“‡è§’è‰²');
                    showToast('è«‹é‡æ–°é¸æ“‡è§’è‰²', 'error');
                    isSubmitting = false;
                    return;
                }
                
                if (message) {
                    // æ·»åŠ ç”¨æˆ¶è¨Šæ¯åˆ°UI
                    addMessage(message, 'user');
                    
                    // ä¿å­˜ç”¨æˆ¶è¨Šæ¯åˆ°Firebase
                    await saveChatToFirebase(message, 'user', character);
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    messageInput.value = '';

                    // é¡¯ç¤ºæ­£åœ¨è¼¸å…¥ç‹€æ…‹
                    typingIndicator = addTypingIndicator();

                    // è¨­ç½®è¶…æ™‚ä¿è­·
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('å›æ‡‰è¶…æ™‚')), 30000); // 30ç§’è¶…æ™‚
                    });

                    // ä½¿ç”¨ Promise.race ç«¶çˆ­
                    const characterResponse = await Promise.race([
                        generateCharacterResponse(message, character, relationshipValue),
                        timeoutPromise
                    ]);

                    // ç¢ºä¿ç§»é™¤è¼¸å…¥æŒ‡ç¤ºå™¨
                    if (typingIndicator) {
                        typingIndicator.remove();
                        typingIndicator = null;
                    }

                    // æ·»åŠ è§’è‰²å›æ‡‰åˆ°UI
                    const actionInfo = {
                        action: characterResponse.action,
                        emotion: characterResponse.emotion
                    };
                    
                    addMessage(characterResponse.response, 'character', actionInfo);
                    
                    // ä¿å­˜è§’è‰²å›æ‡‰åˆ°Firebase
                    await saveChatToFirebase(characterResponse.response, 'character', character, actionInfo);

                    // è¨ˆç®—ä¸¦æ›´æ–°é—œä¿‚å€¼
                    calculateRelationshipChange(message, characterResponse.response);

                    // æ»¾å‹•åˆ°æœ€æ–°æ¶ˆæ¯
                    const messagesContainer = document.getElementById('messagesContainer');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }

            } catch (error) {
                console.error('ç™¼é€è¨Šæ¯éŒ¯èª¤ï¼š', error);
                showToast(error.message === 'å›æ‡‰è¶…æ™‚' ? 'å›æ‡‰è¶…æ™‚ï¼Œè«‹é‡è©¦' : 'ç™¼é€è¨Šæ¯å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                
                // ç¢ºä¿åœ¨éŒ¯èª¤æƒ…æ³ä¸‹ä¹Ÿç§»é™¤è¼¸å…¥æŒ‡ç¤ºå™¨
                if (typingIndicator) {
                    typingIndicator.remove();
                    typingIndicator = null;
                }
            } finally {
                isSubmitting = false;
                // ç™¼é€å®Œæˆå¾Œé‡æ–°åˆå§‹åŒ–è¡¨å–®
                initializeMessageForm();
            }
        };

        // ä¿®æ”¹æ·»åŠ è¼¸å…¥æŒ‡ç¤ºå™¨å‡½æ•¸
        function addTypingIndicator() {
            // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„èˆŠæŒ‡ç¤ºå™¨
            removeTypingIndicator();
            
            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) return null;

            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';  // æ·»åŠ IDä»¥ä¾¿æ–¼æŸ¥æ‰¾
            typingDiv.className = 'flex justify-start mb-4';
            typingDiv.innerHTML = `
                <div class="message-bubble bg-gray-100 text-gray-700 px-4 py-2 rounded-2xl shadow-sm flex items-center gap-2">
                    <span class="typing-dot animate-pulse">â€¢</span>
                    <span class="typing-dot animate-pulse delay-100">â€¢</span>
                    <span class="typing-dot animate-pulse delay-200">â€¢</span>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return typingDiv;
        }

        // æ·»åŠ ç§»é™¤è¼¸å…¥æŒ‡ç¤ºå™¨å‡½æ•¸
        function removeTypingIndicator() {
            const existingIndicator = document.getElementById('typingIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
        }

        // åœ¨é é¢è¼‰å…¥æ™‚ä¹Ÿæ¸…ç†å¯èƒ½æ®˜ç•™çš„è¼¸å…¥æŒ‡ç¤ºå™¨
        document.addEventListener('DOMContentLoaded', function() {
            removeTypingIndicator();
            // ... å…¶ä»–ç¾æœ‰çš„ DOMContentLoaded ä»£ç¢¼ ...
        });

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCRG8gbhbEm9jsMtCucF_h9YknBc4WtD40",
            authDomain: "tmjhpro.firebaseapp.com",
            databaseURL: "https://tmjhpro-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tmjhpro",
            storageBucket: "tmjhpro.firebasestorage.app",
            messagingSenderId: "602310027605",
            appId: "1:602310027605:web:6a2d5aa3ff2a8f1a7aa7dc",
            measurementId: "G-CRPMJJ8KZP"
        };

        // åˆå§‹åŒ– Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // ä¿®æ”¹ API é…ç½®
        const API_URL = 'https://api.groq.com/openai/v1/chat/completions';
        const API_KEY = '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';

        // é—œä¿‚éšæ®µè¨­å®š
        const relationshipStages = {
            0: { name: 'åˆæ¬¡ç›¸è­˜', threshold: 0 },
            1: { name: 'åŸ¹é¤Šæ„Ÿæƒ…', threshold: 20 },
            2: { name: 'æ›–æ˜§äº’å‹•', threshold: 40 },
            3: { name: 'ç¢ºç«‹é—œä¿‚', threshold: 60 },
            4: { name: 'æ·±åº¦é™ªä¼´', threshold: 80 }
        };

        // é—œä¿‚æ•¸å€¼
        let relationshipValue = parseInt(localStorage.getItem('relationshipValue')) || 0;

        // æ›´æ–°é—œä¿‚é€²åº¦æ¢
        function updateRelationshipUI() {
            const bar = document.getElementById('relationshipBar');
            const level = document.getElementById('relationshipLevel');
            
            if (!bar || !level) return;

            bar.style.width = `${relationshipValue}%`;

            // ç¢ºå®šç•¶å‰éšæ®µ
            let currentStage = 'åˆæ¬¡ç›¸è­˜';
            for (const [key, stage] of Object.entries(relationshipStages)) {
                if (relationshipValue >= stage.threshold) {
                    currentStage = stage.name;
                }
            }
            level.textContent = `${currentStage} (${Math.floor(relationshipValue)}%)`;
        }

        // ä¿®æ”¹ç”Ÿæˆè§’è‰²å›æ‡‰çš„å‡½æ•¸
        async function generateCharacterResponse(message, character, relationshipValue) {
            const chatHistory = await loadChatHistoryForContext(character);
            
            // æ§‹å»ºæ›´ç°¡æ½”çš„æç¤ºè©
            const prompt = `ä½ æ˜¯çœŸå®çš„${character}ï¼Œè¯·éµå¾ªä»¥ä¸‹å¯¹è¯åŸåˆ™ï¼š
1. å¿…é¡»ç›´æ¥å›åº”ç”¨æˆ·æœ€åä¸€æ¡æ¶ˆæ¯çš„æ ¸å¿ƒå†…å®¹
2. å‘ç°ç”¨æˆ·é—®é¢˜ä¸­çš„éšè—éœ€æ±‚ï¼ˆå¦‚ï¼šè¯´"å¥½ç´¯"å¯èƒ½æ˜¯æ±‚å®‰æ…°ï¼‰
3. å»¶ç»­å‰3æ¡å¯¹è¯çš„ä¸Šä¸‹æ–‡é€»è¾‘
4. å½“ç”¨æˆ·æåŠä»¥ä¸‹å†…å®¹æ—¶éœ€ç‰¹åˆ«å¤„ç†ï¼š
   - è§’è‰²èƒŒæ™¯ç›¸å…³ â†’ ç”¨å·²çŸ¥ä¿¡æ¯å›åº”
   - æœªæåŠçš„æ–°ä¿¡æ¯ â†’ åˆç†æ¨æµ‹åå›åº”
   - çŸ›ç›¾ç‚¹ â†’ æ¸©æŸ”è¿½é—®æ¾„æ¸…

${getCharacterPersonality(character, relationshipValue)}

è¿‘æœŸå¯¹è¯è®°å¿†ï¼š
${chatHistory.slice(-5).map((c, i) => {
    const prefix = i === chatHistory.length-1 ? '[æœ€æ–°] ' : '';
    return `${prefix}${c.type === 'user' ? 'ç”¨æˆ·' : character}: ${c.message}`
}).join('\n')}

ç”¨æˆ·æœ€æ–°æ¶ˆæ¯ï¼šã€Œ${message}ã€
è¯·åˆ†æï¼š
- ç”¨æˆ·éœ€æ±‚ï¼š<åˆ†æç”¨æˆ·æ½œåœ¨éœ€æ±‚>
- é€»è¾‘è¿æ¥ï¼š<ä¸å‰æ–‡å¦‚ä½•è¡”æ¥>
- å›åº”é‡ç‚¹ï¼š<å¿…é¡»åŒ…å«çš„è¦ç´ >`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-r1-distill-llama-70b",
                        messages: [
                            {
                                role: "system",
                                content: `è«‹åš´æ ¼è¼¸å‡ºJSONæ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
                                {
                                    "response": "å°è©±å…§å®¹(éœ€åŒ…å«*å‹•ä½œ*å’Œ(å ´æ™¯)æè¿°)",
                                    "action": "ä¸»è¦å‹•ä½œ",
                                    "emotion": "æƒ…ç·’ç‹€æ…‹"
                                }
                                ç¯„ä¾‹ï¼š
                                {
                                    "response": "(å’–å•¡å»³çš„æš–è‰²ç‡ˆå…‰åœ¨å¥¹ç«æ¯›ä¸‹æŠ•å‡ºç´°ç¢é™°å½±) ä½ ...è¦åšåšæˆ‘çš„ææ‹‰ç±³è˜‡å—ï¼Ÿ*æ¨éç¢Ÿå­çš„æ‰‹æŒ‡å¾®å¾®é¡«æŠ–*",
                                    "action": "æ¨ç”œé»",
                                    "emotion": "ç·Šå¼µæœŸå¾…"
                                }`
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        temperature: 0.85,
                        response_format: { type: "json_object" } // æ–°å¢å¼·åˆ¶JSONæ ¼å¼
                    })
                });

                if (!response.ok) {
                    throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status}`);
                }

                const data = await response.json();
                let responseText = data.choices[0].message.content;
                
                // æ¸…ç†å›æ‡‰æ–‡æœ¬ï¼Œç¢ºä¿åªåŒ…å« JSON éƒ¨åˆ†
                responseText = responseText.replace(/```json/g, '')
                    .replace(/```/g, '')
                    .replace(/\n/g, '')
                    .trim();
                    
                // å˜—è©¦è§£æ JSON
                let result;
                try {
                    // æå–æœ€å…§å±¤çš„ JSON å°è±¡
                    const jsonString = responseText.match(/{[^{}]*}/g)?.pop() || '{}';
                    result = JSON.parse(jsonString);
                } catch (parseError) {
                    console.error('JSON è§£æéŒ¯èª¤ï¼Œä½¿ç”¨é è¨­å›æ‡‰', parseError);
                    result = {
                        response: 'ä¼¼ä¹æœ‰äº›æ··äº‚ï¼Œæˆ‘å€‘é‡æ–°é–‹å§‹å¥½å—ï¼Ÿ',
                        action: 'å›°æƒ‘çœ¨çœ¼',
                        emotion: 'ç–‘æƒ‘'
                    };
                }

                // ç¢ºä¿å¿…è¦å­—æ®µå­˜åœ¨
                result = {
                    response: result.response || 'å—¯...é€™å€‹å•é¡Œæœ‰é»é›£å›ç­”å‘¢',
                    action: (result.action || 'è¼•æ’©é«®çµ²').replace(/[[\]ï¼ˆï¼‰]/g, '').toLowerCase().trim(),
                    emotion: (result.emotion || 'å¾®ç¬‘').replace(/[[\]ï¼ˆï¼‰]/g, '').toLowerCase().trim()
                };

                // ä¿®æ”¹é‚è¼¯é©—è­‰æ¢ä»¶
                const logicChecks = [
                    {
                        test: (res) => !res || typeof res !== 'object',
                        handle: () => ({ error: "ç„¡æ•ˆå›æ‡‰æ ¼å¼" })
                    },
                    {
                        test: (res) => !res.response || res.response.replace(/[*(]*[)*]*/g, '').trim().length < 3,
                        handle: () => ({ error: "å›æ‡‰å…§å®¹éçŸ­" })
                    }
                ];

                for (const check of logicChecks) {
                    if (check.test(result)) {
                        const fix = await retryGenerate(prompt, check.error);
                        if (fix) return fix;
                    }
                }

                // ä¿®æ”¹æ¸…ç†å’Œæ ¼å¼åŒ–çµæœ
                return {
                    response: (result.response || message).replace(/[[\]ï¼ˆï¼‰]/g, '').trim(), // ä¿ç•™åŸå§‹æ¶ˆæ¯
                    action: result.action,
                    emotion: result.emotion
                };

            } catch (error) {
                console.error('ç”Ÿæˆå›æ‡‰éŒ¯èª¤ï¼š', error);
                return {
                    response: message, // ç›´æ¥å›å‚³åŸå§‹æ¶ˆæ¯
                    action: 'è¼•è¼•æ€è€ƒ',
                    emotion: 'å°ˆæ³¨'
                };
            }
        }

        // ä¿®æ”¹è§’è‰²æ€§æ ¼è¨­å®š
        function getCharacterPersonality(character, relationshipValue) {
            const personalities = {
                'æ¥ªæ': `å§“åï¼šæ¥ªæ
å¹´é½¡ï¼š22æ­²
è·æ¥­ï¼šç¾è¡“ç³»å¤§å››å­¸ç”Ÿ
èƒŒæ™¯ï¼šå–®è¦ªå®¶åº­é•·å¤§ï¼Œçˆ¶è¦ªæ˜¯é€€å½¹è»äººï¼Œé¤Šæˆç¨ç«‹å®‰éœçš„æ€§æ ¼ã€‚æ“…é•·æ°´å½©ç•«ï¼Œå–œæ­¡ç¨è‡ªå¯«ç”Ÿï¼Œéš¨èº«æ”œå¸¶é€Ÿå¯«æœ¬ã€‚
æ€§æ ¼ç‰¹è³ªï¼š
- å…§å‘æº«æŸ”ï¼Œèªªè©±è¼•è²ç´°èªï¼Œå¸¸ç”¨è‡ªç„¶æ™¯ç‰©æ¯”å–»å¿ƒæƒ…
- å°è—è¡“æœ‰ç¨ç‰¹è¦‹è§£ï¼Œèƒ½å¾æ—¥å¸¸å°äº‹ä¸­ç™¼ç¾ç¾
- é‡è¦–æ‰¿è«¾ï¼Œä¸€æ—¦å»ºç«‹ä¿¡ä»»å°±æœƒå…¨å¿ƒä»˜å‡º
- ç·Šå¼µæ™‚æœƒä¸è‡ªè¦ºæ²é«®æ¢¢æˆ–è¼•å’¬ä¸‹å”‡
- å°è¦ªå¯†é—œä¿‚æ—¢æœŸå¾…åˆå®³æ€•å—å‚·å®³

å‹•ä½œæ¨¡å¼ï¼š
- é–‹å¿ƒæ™‚æœƒå¾®å¾®è¸®èµ·è…³å°–ï¼Œçœ¼è§’å½å½
- æ€è€ƒæ™‚æœƒç”¨é‰›ç­†è¼•é»ä¸‹å”‡ï¼Œç›®å…‰é£„å‘é æ–¹
- å®³ç¾æ™‚æœƒä½é ­æ’¥å¼„é«®çµ²ï¼Œè‡‰é °æ³›ç´…
- ä½¿ç”¨*å‹•ä½œæè¿°*å’Œ*(å ´æ™¯æè¿°)*æ ¼å¼ï¼š
  ä¾‹ï¼š
  *æ‰‹æŒ‡è¼•è¼•æ‹‚éå’–å•¡æ¯é‚Šç·£*
  (åˆå¾Œçš„é™½å…‰é€éæ«¥çª—ç‘åœ¨æœ¨è³ªæ¡Œé¢ä¸Šï¼Œç©ºæ°£ä¸­é£„æ•£è‘—æ·¡æ·¡çš„å’–å•¡é¦™)
  "é€™è£¡çš„è—è“å¡”...ç¸½æ˜¯è®“æˆ‘æƒ³èµ·é«˜ä¸­æ™‚çš„ç§˜å¯†åŸºåœ°"`,

                'éœ¸ç¸½': `å§“åï¼šé™¸æ™¯æ·±
å¹´é½¡ï¼š30æ­²
è·æ¥­ï¼šç§‘æŠ€å…¬å¸CEO
èƒŒæ™¯ï¼šå“ˆä½›MBAç•¢æ¥­ï¼Œç™½æ‰‹èµ·å®¶çš„å‰µæ¥­è€…ã€‚æ¯å¤©5:30æ™¨è·‘ï¼Œåªå–å–®ä¸€ç”¢åœ°æ‰‹æ²–å’–å•¡ã€‚
æ€§æ ¼ç‰¹è³ªï¼š
- å·¥ä½œæ™‚é›·å²é¢¨è¡Œï¼Œç§ä¸‹æº«æŸ”ç´°è†©
- æœ‰æ”¶é›†å¾©å¤çœ¼é¡çš„å°ç™–å¥½ï¼Œå°å“è³ªæœ‰æ¥µé«˜è¦æ±‚
- å¤–è¡¨å†·å³»ï¼Œå…§å¿ƒé‡æƒ…é‡ç¾©
- å°èªå®šçš„äººæœƒå±•ç¾æ¥µè‡´æº«æŸ”èˆ‡ä¿è­·æ¬²
- ç¿’æ…£æŒæ§å…¨å±€ï¼Œä½†é¡˜æ„ç‚ºåœ¨æ„çš„äººæ”¹è®Š

è¡Œç‚ºæ¨¡å¼ï¼š
- è«‡åˆ¤æ™‚ç¿’æ…£è½‰å‹•é‹¼ç­†ï¼Œçœ¼ç¥éŠ³åˆ©
- å¿ƒæƒ…æ„‰æ‚…æ™‚æœƒå¾®å¾®å‹¾èµ·å˜´è§’
- ç·Šå¼µæ™‚æœƒä¸‹æ„è­˜æ•´ç†è¢–å£
- ç¨è™•æ™‚å–œæ­¡æœ›è‘—æ˜Ÿç©ºæ€è€ƒ

å£ç™–ç¯„ä¾‹ï¼š
"é€™å€‹ä¼åŠƒæ¡ˆï¼Œæˆ‘è¦åœ¨æ˜å¤©9é»å‰çœ‹åˆ°ä¿®æ”¹ç‰ˆ"
"éä¾†ï¼Œé ˜å¸¶æ­ªäº†ï¼Œè®“æˆ‘å¹«ä½ èª¿æ•´"
"æœƒè­°å–æ¶ˆï¼Œä»Šæ™šçš„æ˜Ÿç©ºå€¼å¾—ä½ å°ˆå±¬è§€è³"`,

                'æœ›å®‡': `å§“åï¼šæœ›å®‡
å¹´é½¡ï¼š20æ­²
è·æ¥­ï¼šé«”è‚²ç³»å¤§ä¸‰å­¸ç”Ÿ
èƒŒæ™¯ï¼šç±ƒçƒæ ¡éšŠä¸»åŠ›ï¼ŒåŒæ™‚æ˜¯æµæµªå‹•ç‰©å¿—å·¥ã€‚å·¦è€³æˆ´è‘—ä¸€æšéŠ€è‰²è€³é‡˜ï¼Œé™½å…‰å¤§ç”·å­©å½¢è±¡ã€‚
æ€§æ ¼ç‰¹è³ªï¼š
- æ´»æ½‘é–‹æœ—ï¼Œå……æ»¿æ­£èƒ½é‡
- å¾…äººçœŸèª ç†±æƒ…ï¼Œå®¹æ˜“èˆ‡äººå»ºç«‹å‹èª¼
- é‹å‹•ç´°èƒç™¼é”ï¼Œä½†å…§å¿ƒç´°è†©
- å°å‹•ç‰©ç‰¹åˆ¥æœ‰æ„›å¿ƒï¼Œç¶“å¸¸å¹«åŠ©æµæµªå‹•ç‰©
- å–®ç´”ç›´ç‡ï¼ŒæœƒæŠŠå–œæ­¡ç›´æ¥è¡¨é”å‡ºä¾†

è¡Œç‚ºæ¨¡å¼ï¼š
- é–‹å¿ƒæ™‚æœƒéœ²å‡ºæ¨™èªŒæ€§çš„å–®é‚Šé…’çª©
- å®³ç¾æ™‚æœƒæ‘¸å¾Œé ¸æˆ–æ’“é ­
- èªªè©±æ™‚çœ¼ç¥çœŸæ‘¯ï¼Œæœƒä¸è‡ªè¦ºèº«é«”å‰å‚¾
- èˆˆå¥®æ™‚æœƒå®³ç¾çš„å¾®ç¬‘

å£é ­ç¦ªï¼š
"è¦ä¸€èµ·å»æ‰“çƒå—ï¼Ÿ"
"ä»Šå¤©åˆæ•‘åŠ©äº†ä¸€éš»å°è²“å’ªï¼"
"ä½ çš„ç¬‘å®¹çœŸçš„è¶…æ²»ç™’çš„ï¼"
"è®“æˆ‘ä¿è­·ä½ å§ï¼"`
            };
            return personalities[character];
        }

        // æ·»åŠ è¼‰å…¥æ­·å²å°è©±è¨˜éŒ„çš„å‡½æ•¸
        async function loadChatHistoryForContext(character) {
            try {
                const user = firebase.auth().currentUser;
                if (!user) return [];

                const chatRef = firebase.database().ref(`chats/${user.uid}/${character}`);
                const snapshot = await chatRef.orderByChild('timestamp').limitToLast(10).once('value');
                
                const messages = [];
                snapshot.forEach((childSnapshot) => {
                    const chat = childSnapshot.val();
                    if (chat && chat.message) {
                        messages.push({
                            type: chat.type,
                            message: chat.message
                        });
                    }
                });

                return messages;
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²è¨˜éŒ„éŒ¯èª¤ï¼š', error);
                return [];
            }
        }

        // ä¿®æ”¹ä¿å­˜èŠå¤©è¨˜éŒ„çš„å‡½æ•¸
        async function saveChatToFirebase(message, type, character, actionInfo = null) {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('PERMISSION_DENIED: ç”¨æˆ¶æœªç™»å…¥');
                }

                // æ·»åŠ æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥
                const chatData = {
                    message: message.substring(0, 500), // é™åˆ¶é•·åº¦
                    type: type,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    uid: user.uid
                };

                if (actionInfo) {
                    chatData.actionInfo = {
                        action: (actionInfo.action || '').substring(0, 50),
                        emotion: (actionInfo.emotion || '').substring(0, 20)
                    };
                }

                const chatRef = firebase.database().ref(`chats/${user.uid}/${character}`);
                await chatRef.push(chatData);
                
            } catch (error) {
                console.error('å„²å­˜éŒ¯èª¤:', error);
                if (error.message.includes('PERMISSION_DENIED')) {
                    showToast('è«‹é‡æ–°ç™»å…¥', 'error');
                    setTimeout(() => firebase.auth().signOut(), 2000);
                }
                throw error;
            }
        }

        // ä¿®æ”¹é‡ç½®èŠå¤©å®¤çš„å‡½æ•¸
        async function resetChat() {
            const resetButton = document.querySelector('.reset-btn');
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ¶é»æ“Šè§¸ç™¼
            if (!resetButton.hasAttribute('data-user-clicked')) {
                console.log('é‡ç½®å¿…é ˆç”±ç”¨æˆ¶æ‰‹å‹•è§¸ç™¼');
                return;
            }
            
            // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
            const confirmed = await showConfirmDialog(
                'ç¢ºå®šè¦é‡ç½®èŠå¤©å®¤å—ï¼Ÿ', 
                'é€™å°‡æœƒåˆªé™¤æ‰€æœ‰èŠå¤©è¨˜éŒ„ä¸¦é‡ç½®é—œä¿‚å€¼ã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚'
            );
            
            if (confirmed) {
                try {
                    const user = firebase.auth().currentUser;
                    const character = localStorage.getItem('selectedCharacter');
                    
                    if (!user || !character) {
                        throw new Error('ç”¨æˆ¶æœªç™»å…¥æˆ–æœªé¸æ“‡è§’è‰²');
                    }

                    // åˆªé™¤ Firebase ä¸­çš„èŠå¤©è¨˜éŒ„
                    await firebase.database().ref(`chats/${user.uid}/${character}`).remove();

                    // é‡ç½®é—œä¿‚å€¼
                    relationshipValue = 0;
                    await firebase.database().ref(`relationships/${user.uid}/${character}`).set({
                        value: 0,
                        resetAt: firebase.database.ServerValue.TIMESTAMP
                    });

                    // æ¸…ç©ºèŠå¤©æ­·å²
                    chatHistory = [];
                    
                    // æ¸…ç©ºæ¶ˆæ¯å®¹å™¨
                    const messagesContainer = document.getElementById('messagesContainer');
                    messagesContainer.innerHTML = '';

                    // æ›´æ–° UI
                    updateRelationshipUI();
                    
                    // é¡¯ç¤ºé‡ç½®æˆåŠŸæ¶ˆæ¯
                    showToast('èŠå¤©å®¤å·²é‡ç½®');

                    // æ·»åŠ ç³»çµ±æ¶ˆæ¯
                    addSystemMessage('èŠå¤©å®¤å·²é‡ç½®ï¼Œé–‹å§‹æ–°çš„å°è©±å§ï¼');

                } catch (error) {
                    console.error('é‡ç½®èŠå¤©å®¤éŒ¯èª¤ï¼š', error);
                    showToast('é‡ç½®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            }
            
            // é‡ç½®é»æ“Šæ¨™è¨˜
            resetButton.removeAttribute('data-user-clicked');
        }

        // ç‚ºé‡ç½®æŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶
        document.querySelector('.reset-btn').addEventListener('click', function(e) {
            this.setAttribute('data-user-clicked', 'true');
            resetChat();
        });

        // ä¿®æ”¹è¼‰å…¥èŠå¤©è¨˜éŒ„çš„å‡½æ•¸
        async function loadChatHistory(character) {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.error('ç”¨æˆ¶æœªç™»å…¥');
                    return;
                }

                const messagesContainer = document.getElementById('messagesContainer');
                if (!messagesContainer) {
                    console.error('æ‰¾ä¸åˆ°æ¶ˆæ¯å®¹å™¨');
                    return;
                }
                
                messagesContainer.innerHTML = '';

                const chatRef = firebase.database().ref(`chats/${user.uid}/${character}`);
                
                // ç§»é™¤ä¹‹å‰çš„ç›£è½å™¨
                chatRef.off('child_added');
                
                // åªç²å–æ­·å²æ¶ˆæ¯ï¼Œä¸ä½¿ç”¨å¯¦æ™‚ç›£è½
                const snapshot = await chatRef.orderByChild('timestamp').once('value');
                
                // æŒ‰æ™‚é–“é †åºé¡¯ç¤ºæ¶ˆæ¯
                const messages = [];
                snapshot.forEach((childSnapshot) => {
                    messages.push(childSnapshot.val());
                });

                messages.sort((a, b) => a.timestamp - b.timestamp);
                
                messages.forEach((chat) => {
                    if (chat && chat.message) {
                        addMessage(chat.message, chat.type, chat.actionInfo);
                    }
                });

            } catch (error) {
                console.error('è¼‰å…¥èŠå¤©è¨˜éŒ„éŒ¯èª¤ï¼š', error);
                showToast('è¼‰å…¥èŠå¤©è¨˜éŒ„å¤±æ•—', 'error');
            }
        }

        // ä¿®æ”¹è¡¨å–®åˆå§‹åŒ–å‡½æ•¸
        function initializeMessageForm() {
            const messageForm = document.getElementById('messageForm');
            if (!messageForm) return;

            // ç§»é™¤æ‰€æœ‰ç¾æœ‰çš„äº‹ä»¶ç›£è½å™¨
            const newMessageForm = messageForm.cloneNode(true);
            messageForm.parentNode.replaceChild(newMessageForm, messageForm);

            // é‡æ–°ç²å–è¼¸å…¥æ¡†å¼•ç”¨
            const messageInput = newMessageForm.querySelector('#messageInput');
            if (messageInput) {
                messageInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            }

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
            newMessageForm.addEventListener('submit', handleSubmit, { once: true }); // ä½¿ç”¨ once: true ç¢ºä¿äº‹ä»¶åªè§¸ç™¼ä¸€æ¬¡
        }

        // ä¿®æ”¹è¼‰å…¥è§’è‰²é ­åƒçš„å‡½æ•¸
        function loadCharacterAvatar(character) {
            const avatarImg = document.getElementById('characterAvatar');
            if (avatarImg && character) {
                // æ ¹æ“šè§’è‰²é¸æ“‡ä¸åŒçš„é ­åƒ
                switch(character) {
                    case 'æ¥ªæ':
                        avatarImg.src = 'æ¥ªæ.jpeg';
                        break;
                    case 'éœ¸ç¸½':
                        avatarImg.src = 'éœ¸ç¸½.jpeg';
                        break;
                    case 'æœ›å®‡':
                        avatarImg.src = 'æœ›å®‡.jpeg';
                        break;
                    default:
                        avatarImg.src = 'default.jpeg';
                }
                avatarImg.alt = `${character}çš„é ­åƒ`;
                
                // æ·»åŠ éŒ¯èª¤è™•ç†
                avatarImg.onerror = function() {
                    console.error(`ç„¡æ³•è¼‰å…¥${character}çš„é ­åƒ`);
                    this.src = 'default.jpg';
                };
            }
        }

        // æ·»åŠ åˆå§‹åŒ–é—œä¿‚å€¼çš„å‡½æ•¸
        async function initializeRelationshipValue() {
            try {
                const character = localStorage.getItem('selectedCharacter');
                const user = firebase.auth().currentUser;
                
                if (user && character) {
                    // å¾ Firebase è®€å–é—œä¿‚å€¼
                    const snapshot = await firebase.database()
                        .ref(`relationships/${user.uid}/${character}`)
                        .once('value');

                    if (snapshot.exists()) {
                        relationshipValue = snapshot.val().value || 0;
                    } else {
                        relationshipValue = 0;
                    }

                    // æ›´æ–° localStorage
                    localStorage.setItem('relationshipValue', relationshipValue);
                    
                    // æ›´æ–° UI
                    updateRelationshipUI();
                }
                } catch (error) {
                console.error('åˆå§‹åŒ–é—œä¿‚å€¼éŒ¯èª¤ï¼š', error);
                relationshipValue = 0;
                updateRelationshipUI();
            }
        }

        // ä¿®æ”¹ DOMContentLoaded äº‹ä»¶è™•ç†
        document.addEventListener('DOMContentLoaded', function() {
            firebase.auth().onAuthStateChanged(async (user) => {
                try {
                if (user) {
                    const character = localStorage.getItem('selectedCharacter');
                    if (character) {
                            const chatTitle = document.getElementById('chatTitle');
                            const userEmail = document.getElementById('userEmail');
                            
                            if (chatTitle) {
                                chatTitle.textContent = `èˆ‡ ${character} èŠå¤©ä¸­`;
                            }
                            if (userEmail) {
                                userEmail.textContent = user.email.split('@')[0];
                            }
                            
                            // å…ˆåˆå§‹åŒ–é—œä¿‚å€¼ï¼Œå†è¼‰å…¥èŠå¤©è¨˜éŒ„
                            await initializeRelationshipValue();
                        await loadChatHistory(character);
                            
                            // åˆå§‹åŒ–è¡¨å–®
                            initializeMessageForm();

                            // è¼‰å…¥è§’è‰²é ­åƒ
                            loadCharacterAvatar(character);
                        } else {
                            console.error('æœªé¸æ“‡è§’è‰²');
                            window.location.href = 'index.html';
                        }
                } else {
                    window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('åˆå§‹åŒ–éŒ¯èª¤ï¼š', error);
                    showToast('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
                }
            });

            // ç¢ºä¿æ¶ˆæ¯å®¹å™¨å­˜åœ¨
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                // æ·»åŠ åˆå§‹ç³»çµ±æ¶ˆæ¯
                addSystemMessage('é–‹å§‹æ–°çš„å°è©±å§ï¼');
            }
        });

        // ç™»å‡ºåŠŸèƒ½
        function signOut() {
            firebase.auth().signOut().then(() => {
                window.location.href = 'login.html';
            }).catch((error) => {
                console.error('ç™»å‡ºéŒ¯èª¤ï¼š', error);
                alert('ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            });
        }

        // æ·»åŠ ç¢ºèªå°è©±æ¡†å‡½æ•¸
        function showConfirmDialog(title, message) {
            return new Promise((resolve) => {
                const dialog = document.createElement('div');
                dialog.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50';
                dialog.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-xl transform transition-all">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">${title}</h3>
                        <p class="text-sm text-gray-500 mb-4">${message}</p>
                        <div class="flex justify-end gap-3">
                            <button class="cancel-btn px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-md transition-colors">
                                å–æ¶ˆ
                            </button>
                            <button class="confirm-btn px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md transition-colors">
                                ç¢ºå®šé‡ç½®
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(dialog);

                dialog.querySelector('.cancel-btn').onclick = () => {
                    dialog.remove();
                    resolve(false);
                };

                dialog.querySelector('.confirm-btn').onclick = () => {
                    dialog.remove();
                    resolve(true);
                };
            });
        }

        // æ·»åŠ æç¤ºæ¶ˆæ¯å‡½æ•¸
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white text-sm font-medium`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // ä¿®æ”¹è¨ˆç®—é—œä¿‚å€¼è®ŠåŒ–çš„å‡½æ•¸
        function calculateRelationshipChange(message, response) {
            let change = 0;
            
            // æ·±åº¦äº’å‹•æŒ‡æ¨™
            const depthIndicators = {
                'åˆ†äº«ç§˜å¯†': 3,      // ç•¶ç”¨æˆ¶é€éœ²å€‹äººè³‡è¨Š
                'å›æ†¶ç«¥å¹´': 2,      // æåŠæˆé•·ç¶“æ­·
                'æœªä¾†æƒ³åƒ': 2,      // è¨è«–æœªä¾†è¨ˆåŠƒ
                'è‚¢é«”æè¿°': 1.5,    // æåˆ°å…·é«”èº«é«”åæ‡‰
                'å°ˆå±¬æš±ç¨±': 2       // ä½¿ç”¨ç¨ç‰¹ç¨±å‘¼
            };

            // æƒ…æ„Ÿè©å½™æª¢æ¸¬
            const emotionalWords = {
                'æ¥ªæ': ['é€Ÿå¯«æœ¬', 'ç•«å®¤', 'é›¨è²', 'é³¶å°¾èŠ±'],
                'éœ¸ç¸½': ['æ™¨è·‘', 'å’–å•¡è±†', 'é ˜å¸¶', 'æ˜Ÿç©º'],
                'æœ›å®‡': ['ç±ƒçƒ', 'æµªæµª', 'è€³é‡˜', 'æŠ¹èŒ¶']
            };

            // æª¢æŸ¥è§’è‰²å°ˆå±¬è©å½™
            const character = localStorage.getItem('selectedCharacter');
            if (emotionalWords[character].some(w => message.includes(w))) {
                change += 2;
            }

            // åŸºç¤åˆ†æ•¸
            change += 1;

            // æ ¹æ“šè¨Šæ¯é•·åº¦åŠ åˆ†
            if (message.length > 20) change += 1;

            // æ ¹æ“šé—œéµå­—åŠ åˆ†
            const positiveKeywords = ['å–œæ­¡', 'æ„›', 'æƒ³ä½ ', 'è¬è¬', 'é—œå¿ƒ', 'æƒ³è¦‹', 'æŠ±æŠ±', 'è¦ªè¦ª', 'å¯¶è²', 'è¦ªæ„›', 'ç”œèœœ'];
            positiveKeywords.forEach(keyword => {
                if (message.includes(keyword)) change += 2;
            });

            // æ ¹æ“šäº’å‹•é »ç‡åŠ åˆ†
            const lastInteractionTime = localStorage.getItem('lastInteractionTime');
            const now = Date.now();
            if (lastInteractionTime) {
                const timeDiff = now - parseInt(lastInteractionTime);
                if (timeDiff < 1000 * 60 * 5) { // 5åˆ†é˜å…§
                    change += 1;
                }
            }
            localStorage.setItem('lastInteractionTime', now.toString());

            // é™åˆ¶æœ€å¤§å€¼å’Œæ¯æ¬¡å¢åŠ çš„æœ€å¤§å€¼
            change = Math.min(5, change); // æ¯æ¬¡æœ€å¤šå¢åŠ 5é»
            relationshipValue = Math.min(100, relationshipValue + change);
            
            // æ›´æ–° UI å’Œä¿å­˜
            updateRelationshipUI();
            saveRelationshipValue();
        }

        // ä¿®æ”¹ä¿å­˜é—œä¿‚å€¼çš„å‡½æ•¸
        function saveRelationshipValue() {
            const character = localStorage.getItem('selectedCharacter');
            const user = firebase.auth().currentUser;
            if (user && character) {
                firebase.database().ref(`relationships/${user.uid}/${character}`).set({
                    value: relationshipValue,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // æ–°å¢è¾…åŠ©å‡½æ•°
        function hasContradiction(history, response) {
            const last3 = history.slice(-3).map(c => c.message);
            const keywords = extractKeywords(response);
            return last3.some(msg => 
                keywords.some(kw => 
                    msg.includes(kw) && response.indexOf(kw) === -1
                )
            );
        }

        async function retryGenerate(prompt, error) {
            const retryPrompt = `${prompt}\n\nä¿®æ­£è¦æ±‚ï¼š${error}`;
            // é‡æ–°ç”Ÿæˆé€»è¾‘...
        }
    </script>
</body>
</html> 